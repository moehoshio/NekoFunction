name: Neko Function CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          # Windows builds
          - {
              name: "Windows MSVC Module Debug",
              os: windows-latest,
              cc: "cl",
              cxx: "cl",
              build_type: "Debug",
              generators: "Visual Studio 17 2022",
              enable_module: "ON"
            }
          - {
              name: "Windows MSVC Module Release",
              os: windows-latest,
              cc: "cl",
              cxx: "cl",
              build_type: "Release",
              generators: "Visual Studio 17 2022",
              enable_module: "ON"
            }
          
          # Linux builds
          - {
              name: "Ubuntu GCC Debug",
              os: ubuntu-latest,
              cc: "gcc",
              cxx: "g++",
              build_type: "Debug",
              generators: "Unix Makefiles",
              enable_module: "OFF"
            }
          - {
              name: "Ubuntu GCC Release",
              os: ubuntu-latest,
              cc: "gcc",
              cxx: "g++",
              build_type: "Release",
              generators: "Unix Makefiles",
              enable_module: "OFF"
            }
          - {
              name: "Ubuntu Clang Debug",
              os: ubuntu-latest,
              cc: "clang",
              cxx: "clang++",
              build_type: "Debug",
              generators: "Unix Makefiles",
              enable_module: "OFF"
            }
          - {
              name: "Ubuntu Clang Release",
              os: ubuntu-latest,
              cc: "clang",
              cxx: "clang++",
              build_type: "Release",
              generators: "Unix Makefiles",
              enable_module: "OFF"
            }
          - {
              name: "Ubuntu Clang-18 Module Debug",
              os: ubuntu-latest,
              cc: "clang-18",
              cxx: "clang++-18",
              build_type: "Debug",
              generators: "Ninja",
              enable_module: "ON"
            }
          - {
              name: "Ubuntu Clang-21 Module Release",
              os: ubuntu-latest,
              cc: "clang-21",
              cxx: "clang++-21",
              build_type: "Release",
              generators: "Ninja",
              enable_module: "ON"
            }

          # macOS builds
          - {
              name: "macOS Clang Debug",
              os: macos-latest,
              cc: "clang",
              cxx: "clang++",
              build_type: "Debug",
              generators: "Unix Makefiles",
              enable_module: "OFF"
            }
          - {
              name: "macOS Clang Release",
              os: macos-latest,
              cc: "clang",
              cxx: "clang++",
              build_type: "Release",
              generators: "Unix Makefiles",
              enable_module: "OFF"
            }
          - {
              name: "macOS GCC Debug",
              os: macos-latest,
              cc: "gcc",
              cxx: "g++",
              build_type: "Debug",
              generators: "Unix Makefiles",
              enable_module: "OFF"
            }
          - {
              name: "macOS GCC Release",
              os: macos-latest,
              cc: "gcc",
              cxx: "g++",
              build_type: "Release",
              generators: "Unix Makefiles",
              enable_module: "OFF"
            }


    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Ninja (Ubuntu)
      if: startsWith(matrix.config.os, 'ubuntu')
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build

    - name: Install Ninja (macOS)
      if: startsWith(matrix.config.os, 'macos')
      run: |
        brew install ninja

    - name: Install Clang 18 (Ubuntu)
      if: startsWith(matrix.config.os, 'ubuntu') && matrix.config.cc == 'clang-18'
      run: |
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main"
        sudo apt-get update
        sudo apt-get install -y clang-18 clang++-18

    - name: Install Clang 21 (Ubuntu)
      if: startsWith(matrix.config.os, 'ubuntu') && matrix.config.cc == 'clang-21'
      run: |
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-21 main"
        sudo apt-get update
        sudo apt-get install -y clang-21 clang++-21

    - name: Check compiler versions (Unix)
      if: "!startsWith(matrix.config.os, 'windows')"
      run: |
        echo "=== Compiler Information ==="
        ${{ matrix.config.cxx }} --version
        echo "=== CMake Information ==="
        cmake --version
        echo "=== Ninja Information ==="
        ninja --version

    # ============================================================================
    # Install vcpkg (Unix)
    # ============================================================================
    - name: Install vcpkg (Unix)
      if: "!startsWith(matrix.config.os, 'windows')"
      run: |
        echo "=== Installing Vcpkg ==="
        git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
        ~/vcpkg/bootstrap-vcpkg.sh

        VCPKG_ROOT=~/vcpkg
        echo "VCPKG_ROOT=$VCPKG_ROOT" >> $GITHUB_ENV

    # ============================================================================
    # Install packages via vcpkg (Unix)
    # ============================================================================
    - name: Install dependencies via vcpkg (Unix)
      if: "!startsWith(matrix.config.os, 'windows')"
      run: |
        echo "=== Installing dependencies via vcpkg ==="
        ~/vcpkg/vcpkg install zlib openssl minizip-ng

    # ============================================================================
    # Windows: Use default vcpkg
    # ============================================================================
    - name: Install dependencies via vcpkg (Windows)
      if: startsWith(matrix.config.os, 'windows')
      run: |
        Write-Host "=== Installing dependencies via vcpkg ==="
        $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
        Write-Host "Using vcpkg at: $vcpkgRoot"
        
        vcpkg install openssl:x64-windows minizip-ng:x64-windows --recurse
        Write-Host ""
        Write-Host "=== Installed packages ==="
        vcpkg list
        Write-Host ""
        Write-Host "=== Verifying installation ==="
        $installedPath = "$vcpkgRoot\installed\x64-windows"
        Write-Host "Installed path: $installedPath"
        if (Test-Path "$installedPath\share\minizip-ng") {
          Write-Host "minizip-ng CMake files: OK"
        } else {
          Write-Host "minizip-ng CMake files: NOT FOUND"
        }
        if (Test-Path "$installedPath\share\openssl") {
          Write-Host "OpenSSL CMake files: OK"
        } else {
          Write-Host "OpenSSL CMake files: NOT FOUND"
        }
      shell: powershell

    - name: Set up MSVC environment (Windows)
      if: startsWith(matrix.config.os, 'windows') && matrix.config.cc == 'cl'
      uses: ilammy/msvc-dev-cmd@v1.13.0

    # ============================================================================
    # Configure CMake for all platforms
    # ============================================================================
    - name: Configure CMake (Windows)
      if: startsWith(matrix.config.os, 'windows')
      run: |
        Write-Host "=== Configuring NekoFunction (Windows) ==="
        $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
        $toolchainFile = "$vcpkgRoot\scripts\buildsystems\vcpkg.cmake"
        $installedPath = "$vcpkgRoot\installed\x64-windows"
        
        Write-Host "VCPKG_ROOT: $vcpkgRoot"
        Write-Host "CMAKE_TOOLCHAIN_FILE: $toolchainFile"
        Write-Host "CMAKE_PREFIX_PATH: $installedPath"
        Write-Host "MODULE_SUPPORT: ${{ matrix.config.enable_module }}"
        
        cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} -G "${{ matrix.config.generators }}" `
          -DNEKO_FUNCTION_BUILD_TESTS=ON -DNEKO_FUNCTION_AUTO_FETCH_DEPS=ON -DNEKO_FUNCTION_ENABLE_MODULE=${{ matrix.config.enable_module }} `
          -DCMAKE_TOOLCHAIN_FILE="$toolchainFile" `
          -DVCPKG_TARGET_TRIPLET=x64-windows `
          -DCMAKE_PREFIX_PATH="$installedPath"
      shell: powershell

    - name: Configure CMake (Ubuntu)
      if: "startsWith(matrix.config.os, 'ubuntu')"
      run: |
        echo "=== Configuring NekoFunction (Ubuntu) ==="
        echo "Compiler: ${{ matrix.config.cxx }}"
        echo "Module support: ${{ matrix.config.enable_module }}"
        cmake -B build -DNEKO_FUNCTION_ENABLE_MODULE=${{ matrix.config.enable_module }} -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} -DCMAKE_C_COMPILER=${{ matrix.config.cc }} -DCMAKE_CXX_COMPILER=${{ matrix.config.cxx }} -G "${{ matrix.config.generators }}" -DNEKO_FUNCTION_BUILD_TESTS=ON -DNEKO_FUNCTION_AUTO_FETCH_DEPS=ON -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DCMAKE_PREFIX_PATH=$VCPKG_ROOT/installed/x64-linux
      shell: bash

    - name: Configure CMake (macOS)
      if: "startsWith(matrix.config.os, 'macos')"
      run: |
        echo "=== Configuring NekoFunction (macOS) ==="
        echo "Compiler: ${{ matrix.config.cxx }}"
        echo "Module support: ${{ matrix.config.enable_module }}"
        cmake -B build -DNEKO_FUNCTION_ENABLE_MODULE=${{ matrix.config.enable_module }} -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} -DCMAKE_C_COMPILER=${{ matrix.config.cc }} -DCMAKE_CXX_COMPILER=${{ matrix.config.cxx }} -G "${{ matrix.config.generators }}" -DNEKO_FUNCTION_BUILD_TESTS=ON -DNEKO_FUNCTION_AUTO_FETCH_DEPS=ON -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake -DCMAKE_PREFIX_PATH=$VCPKG_ROOT/installed/x64-macos
      shell: bash

    - name: Verify Hash and Archive Support
      run: |
        echo "=== NekoFunction Configuration Check ==="
        if grep -q "Hash support enabled: ON" build/CMakeCache.txt 2>/dev/null || grep -rq "Hash support enabled: ON" build/ 2>/dev/null; then
          echo "✓ Hash support is ENABLED"
        else
          echo "✗ Hash support is DISABLED or not found"
        fi
        if grep -q "Archiver support enabled: ON" build/CMakeCache.txt 2>/dev/null || grep -rq "Archiver support enabled: ON" build/ 2>/dev/null; then
          echo "✓ Archiver support is ENABLED"
        else
          echo "✗ Archiver support is DISABLED or not found"
        fi
      shell: bash

    - name: Build
      run: cmake --build build --config ${{ matrix.config.build_type }} --parallel

    - name: Run tests
      working-directory: build
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          if [ "${{ matrix.config.generators }}" = "Visual Studio 17 2022" ] || [ "${{ matrix.config.generators }}" = "Visual Studio 16 2019" ]; then
            ctest -C ${{ matrix.config.build_type }} --output-on-failure --verbose
          else
            ctest --output-on-failure --verbose
          fi
        else
          ctest --output-on-failure --verbose
        fi
      shell: bash

    - name: Upload build artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.config.name }}
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
          build/Testing/Temporary/LastTest.log